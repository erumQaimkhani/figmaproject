"use strict";
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="2aab22ea-6ac3-50c7-a604-defb9ea528f6")}catch(e){}}();
(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[5099],{901765:(e,t,n)=>{n.d(t,{L:()=>a});var l=n(411855);function a(e,t,n){l.useEffect(()=>{let l=l=>{let a=l.target;n&&!a.isConnected||e.current?.contains(a)||t()};return document.addEventListener("click",l),()=>{document.removeEventListener("click",l)}})}},975723:(e,t,n)=>{n.r(t),n.d(t,{EditFeedPostModal:()=>B});var l=n(411855),a=n(188507),d=n(629019),o=n.n(d),i=n(776250),s=n(609494),r=n(966712),c=n(498750),u=n(915440),m=n(27087),f=n(448169),p=n(946689),g=n(493323),y=n(881388),C=n(939863),h=n(392592),E=n(507877),b=n(662275),I=n(654034),P=n(694687),k=n(860178),_=n(279453),v=n(204279),F=n(531827),x=n(28588),T=n(103271),K=n(588282),M=n(126674),S=n(679736),N=n(406158),w=n(757022),D=n(583630),O=n(660040),U=n(160156),A=n(461839),R=n(462256),z=n(782680),L=n(722388),Y=n(674222);function B(e){let t=(0,a.wA)(),n=l.useCallback(()=>{t(b.Ce())},[t]),d=(0,C.tx)("fig_feed.edit_post"),o=e.feedPostUuid;!o&&e.feedPostThreadId&&(o=(0,K.gk)(e.feedPostThreadId));let i=(0,u.Rs)(_.FHz,{publicUuid:o},{enabled:!e.preloadedFeedPost&&!!o}),s=l.useMemo(()=>e.preloadedFeedPost?e.preloadedFeedPost:"loaded"===i.status?i.data.feedPost:null,[e.preloadedFeedPost,i]);return l.createElement(R.j,{title:d,onClose:n},s?l.createElement(Z,{onSubmitSuccess:e.onSubmitSuccess,entryPoint:e.entryPoint,lockedFileKey:e.lockedFileKey,feedPost:s}):l.createElement("div",{className:Y._5},l.createElement(g.kt,{size:"large"})))}function Z(e){let t=(0,a.wA)(),n=(0,P.sZ)(),d=(0,k.iZ)(),[u,_]=l.useState(!0),[K,R]=l.useState(!1),[B,Z]=l.useState(!1),q=e.feedPost.publicUuid,$=l.useMemo(()=>e.feedPost.content.map(e=>JSON.parse(e)),[e.feedPost]),[j,J]=l.useState($.reduce((e,t)=>{if(t.type!==T.cM.NODE)return e;e.fileKey=t.fileKey;let n=t.nodeId;return e.nodeIds.push(n),e},{fileKey:e.feedPost.fileKey||"",nodeIds:[]})),V=l.useMemo(()=>{let e=$.find(e=>e.type===T.cM.PROTOTYPE);return e?{fileKey:e.fileKey,pageId:e.pageId,startingNodeId:e.startingNodeId}:null},[$]),[H,Q]=l.useState(0),X=l.useCallback(()=>{t(b.Ce())},[t]),G=l.useCallback(()=>{t((0,b.to)({type:z.h,data:{onConfirm:X},showModalsBeneath:!0}))},[t,X]),W=e.lockedFileKey||j?.fileKey||V?.fileKey;l.useEffect(()=>{let t={entryPoint:e.entryPoint};W&&(t.fileKey=W),(0,i.sx)("Team Feed Edit Post Modal Opened",t)},[e.entryPoint,W]);let ee=l.useCallback((e,l,a)=>{if(l){t(b.Ce());return}let d={text:(0,C.t)("fig_feed.view_post"),action:()=>{t(E.V3({url:(0,M.Kc)(n.id,{uuid:e})}))}};t(h.F.enqueue({message:(0,C.t)("fig_feed.post_edited"),button:a?d:void 0})),t(b.Ce())},[t,n]),[et,en]=l.useState($.map(e=>{let t=(0,N.EU)(e),n=(0,T.aT)(e)&&!!e.hasPreviousEditPreview,l={...e,copiedToS3:e.type===T.cM.NODE||e.type===T.cM.PROTOTYPE,shouldBlockEditPreview:n&&!t};return{displayContentItem:l,processedContentItem:Promise.resolve(l)}})),el=l.useMemo(()=>new Set(et.map(e=>e.displayContentItem.type===T.cM.NODE?e.displayContentItem.nodeId:null).filter(e=>null!==e)),[et]);l.useEffect(()=>{(0,w.sr)(j,el,en,n?.id)},[j,el,en,n?.id]);let ea=l.useCallback(e=>{let t=(0,U.K1)(et[H].displayContentItem);Q(e.findIndex(e=>(0,U.K1)(e)===t));let n=[];e.forEach(e=>{let t=(0,U.K1)(e),l=et.find(e=>(0,U.K1)(e.displayContentItem)===t);l?n.push(l):console.error("Expected to have a matchedPendingItem")}),en(n)},[et,H]),ed=l.useCallback(e=>{Q(et.findIndex(t=>(0,U.K1)(t.displayContentItem)===e))},[et]),{setContentPreview:eo,snapshotStates:ei}=(0,w.eh)(et,en),{onSubmitSuccess:es}=e,er=l.useCallback((n,l)=>{m.Ay.put(`/api/feed_posts/${q}`,n).then(n=>{ee(n.data.meta.public_uuid,l,e.entryPoint===S.M2.FILE),l&&t(h.F.enqueue({message:(0,C.t)("fig_feed.post_submission_pending")})),es&&es(l)}).catch(()=>{t(y.s.error((0,C.t)("fig_feed.error_on_feed_post_creation"))),_(!1)})},[t,ee,es,q,e.entryPoint]),[ec,eu]=l.useState(e.feedPost.title||""),[em,ef]=l.useState((0,I.o8)(e.feedPost.descriptionMeta)),ep=l.useMemo(()=>({library:new F.M8(n.id)}),[n]);l.useEffect(()=>{_(ec.trim().length>O.Y||(0,s._Z)(em).length>O.e||0===et.length)},[ec,em,et.length]);let eg=async l=>{if(!n||u)return;l?.preventDefault(),_(!0);let a={description_meta:em,org_id:n.id},d=(0,s._Z)(em);a.content=await (0,N.pj)(t,et,W??"",ec),(0,i.sx)("team_feed_content_awaited",{payloadContent:JSON.stringify(a.content)},{logFromProber:!0});let o=a.content.some(e=>e.pending);ec?a.title=ec:a.title=d.length>0?d.slice(0,40)+"\u2026":(0,C.t)("fig_feed.untitled_post"),W&&(a.attached_file_key=W),er(a,o),(0,i.sx)("Team Feed Post Edited",{fileKey:W,entryPoint:e.entryPoint,text:d,numContentItems:a.content.length,contentItemTypes:a.content.map(e=>e.type)},{forwardToDatadog:!0})},ey=l.useCallback((e,l)=>{if(!n)return;let a=Array.from(e);if(0===a.length)return;let d=(0,v.KT)(a,et.length,T.e3,T.bB,e=>{t(h.F.enqueue({message:(0,A.getUploadErrorMessage)(e)}))},et.map(e=>e.fileIdentifier)).map(e=>{let t=(0,v.Fn)(e);if(x.xp.includes(e.type))return(0,N.zr)(t,e);if(x.VY.includes(e.type))return(0,N.X2)(t,q,n.id,e);throw Error("unexpected file type")}),o=void 0!==l?l:et.length;en(e=>[...e.slice(0,o),...d,...e.slice(o)]),Q(o)},[t,n,q,et]),eC=l.useCallback((e,t)=>()=>{let n=e.current?.files||null;null!==n&&0!==n.length&&(ey(n,t),e.current&&(e.current.value=""))},[ey]),eh=l.useCallback(e=>{let t=Math.min(e,Math.max(0,et.length-2)),n=et[e];if((0,N.AK)(n),en(t=>t.filter((t,n)=>n!==e)),n.displayContentItem.type===T.cM.NODE){let e=n.displayContentItem.nodeId;J(t=>{if(t){let n=t.nodeIds.filter(t=>t!==e),l=t.nodeThumbnails,a=l&&n.reduce((e,t)=>(e[t]=l[t],e),{});return{...t,nodeIds:n,nodeThumbnails:a}}return null})}Q(t)},[et]),eE=l.useCallback((e,t)=>{ey(e.files,t),Z(!1)},[ey]),eb=l.useRef(null),eI=!!j?.nodeIds?.length,{openPostFromFileModal:eP,attachedFileData:ek}=(0,w.Ld)({setLinkedFileNodeInfo:J,numUserContentItems:et.length,hasNodeContent:eI,parentModalRef:eb,attachedFileKey:W,lockedFileKey:e.lockedFileKey,currentOrgId:n?.id}),e_=l.useCallback(()=>{let t=et.map(e=>e.displayContentItem);return l.createElement(f.Y,{className:o()(Y.xe,B&&Y.w8),isDragTarget:()=>!0,onTargetDragEnter:()=>Z(!0),onTargetDragLeave:()=>Z(!1),onTargetDrop:e=>eE(e)},l.createElement(U.Zo,{contentItems:t,staticContent:!0,scrollable:!1,deleteItemAtIdx:K?void 0:eh,pageBackgroundColor:e.feedPost.backgroundColor??void 0,onReorderCallback:K?void 0:ea,shouldScrollToIndex:null,selectedIdx:H,setSelectedIdx:Q,onFileInputChange:eC,setSelectedContent:ed,snapshotStates:ei,setContentPreview:eo,openPostFromFileModal:eP,attachedFile:ek,dragging:B,mode:"edit"}))},[e.feedPost,B,ea,eh,K,et,eE,H,eC,ed,ei,eo,eP,ek]),ev=l.useCallback(e=>{e.keyCode===c.Uz.ESCAPE&&X()},[X]);return n&&d&&(0,r.kc)().xr_debounce_threshold?l.createElement("div",{className:Y.RO,onKeyDown:ev,role:"textbox",tabIndex:0,ref:eb},l.createElement("div",{className:Y.q3},e_(),n&&d?l.createElement("div",{className:Y.DA},l.createElement(D.FeedPostUnifiedComposer,{user:d,currentOrgId:n.id,autofocus:!0,mentionables:ep,onSubmit:u?void 0:eg,submitOnEnter:!1,hideSubmitButton:!0,description:em,updateDescription:ef,title:ec,updateTitle:eu,displayDecoratorsDownwards:!0,minimized:!1,readOnly:K,editableTypeaheadClass:L.up,openPostFromFileModal:()=>eP({skipFrameSelection:!eI}),fileData:ek,lockFileAddition:et.length>=T.e3,parentRef:eb,canUnlinkFile:!eI&&!e.lockedFileKey,unlinkFile:()=>J(null)})):null),l.createElement("div",{className:Y.CQ},l.createElement("div",{className:Y._f}),l.createElement("div",{className:Y.UD},l.createElement(p.nR,{onClick:e=>{e.stopPropagation(),G()}},(0,C.tx)("fig_feed.discard_edit")),l.createElement(p.$$,{onClick:e=>{if(!K)return R(!0),eg(e).finally(()=>{R(!1)})},disabled:u,dataTestId:"feed-post-post",className:K?Y.zb:Y.pb},K&&l.createElement("div",{className:Y.YI},l.createElement(g.kt,{shouldMatchTextColor:!0,size:"medium"})),K?(0,C.tx)("fig_feed.saving"):(0,C.tx)("general.save"))))):null}}}]);

//# debugId=2aab22ea-6ac3-50c7-a604-defb9ea528f6

//# sourceMappingURL=https://admin.figma.com/admin/webpack-artifacts/57c3b700aac23c3eb0ee41c548e51a162fe1b488/team_feed-58aa660e86724b56.min.js.map